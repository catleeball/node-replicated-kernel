stages:
  - build
  - run
  - test
  - pages
  - unix

before_script:
  - bash setup.sh
  - rustup --version
  - rustc --version
  - cargo --version
  - cargo +nightly fmt --version
  - sed -i'' -e 's/git@github.com:/https:\/\/github.com\//' .gitmodules
  - git submodule update --init --recursive

build:
  script:
    - cd kernel
    - RUST_TARGET_PATH=`pwd`/src/arch/x86_64 xargo build -v --target=x86_64-bespin
  #artifacts:
  #  paths:
  #    - target/

run:
  script:
    - cd kernel
    - bash run.sh --log trace
  #dependencies:
  #  - build

unix:
  script:
    - cd kernel
    - cargo run
  #dependencies:
  #  - build

test:
  script:
    # Clean up remaining processes
    - sudo killall dhcpd || true
    - sudo killall socat || true
    - cd kernel
    - cargo +nightly fmt --package bespin -- --check
    - RUST_TEST_THREADS=1 cargo test
  #dependencies:
  #  - build

pages:
  script:
    - cd doc
    - mdbook build -d ../public
    - cd ..
    - mkdir -p /home/gitlab/pages-root/bespin/
    - cp -rf public /home/gitlab/pages-root/bespin/book/
    - cargo doc
    - cp -rf target/doc /home/gitlab/pages-root/bespin/doc/
  #dependencies:
  #  - build
  artifacts:
    paths:
      - public